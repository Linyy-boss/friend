<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>和 Sleep Beast 打個招呼 💤</title>
  <style>
    /* 主題：杏仁白 × 霧玫瑰（LINE 風格） */
    :root{
      --almond:#F5E8DC; /* 杏仁白 */
      --rose:#A37070;   /* 霧玫瑰 */
      --ink:#3d3434;    /* 文字主色 */
      --muted:#7b6f6f;  /* 次要文字 */
      --shadow:0 10px 30px rgba(163,112,112,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(160deg, var(--almond) 0%, #fff 60%);color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft JhengHei","PingFang TC", sans-serif;
      display:flex;align-items:center;justify-content:center;padding:24px;
    }

    .phone{width:min(420px,100%);background:#fff;border-radius:28px;border:2px solid var(--rose);
      box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;}
    .topbar{background:var(--rose);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:10px;}
    .beast{width:26px;height:26px;display:inline-block}
    .title{font-weight:700}
    .subtitle{font-size:12px;opacity:.85}

    .chat{background:#fff;display:flex;flex-direction:column;height:68vh;min-height:520px}
    .msgs{flex:1;overflow:auto;padding:16px;background:var(--almond)}
    .msgs::-webkit-scrollbar{width:8px}
    .msgs::-webkit-scrollbar-thumb{background:#d6c2bb;border-radius:6px}

    .row{display:flex;align-items:flex-end;margin:8px 0;gap:8px}
    .row.me{justify-content:flex-end}
    .avatar{width:34px;height:34px;border-radius:999px;background:#fff;border:2px solid var(--rose);
      display:flex;align-items:center;justify-content:center;overflow:hidden}
    .bubble{max-width:70%;padding:10px 12px;border-radius:18px;line-height:1.45;box-shadow:0 2px 0 rgba(0,0,0,.06)}
    .bubble.bot{background:#fff;border:1px solid var(--rose)}
    .bubble.me{background:var(--rose);color:#fff}
    .status{font-size:12px;color:#fff;opacity:.9;margin-left:8px}

    .sys{display:flex;justify-content:center;margin:10px 0}
    .sys span{font-size:12px;color:var(--muted);background:#ffffffaa;border:1px dashed var(--rose);padding:4px 10px;border-radius:999px}

    .input{display:flex;gap:10px;padding:12px;border-top:2px solid var(--rose);background:#fff}
    textarea{flex:1;resize:none;min-height:42px;max-height:120px;padding:10px 12px;border-radius:16px;border:1px solid var(--rose);background:#fff;color:var(--ink)}
    button{border:none;padding:10px 16px;border-radius:14px;font-weight:700;cursor:pointer;background:var(--rose);color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}

    .footer-note{padding:8px 16px;color:var(--muted);font-size:12px}
    a{color:var(--rose);text-decoration:none}
  </style>
</head>
<body>
  <div class="phone" role="application" aria-label="Sleep Beast 留言視窗">
    <div class="topbar">
      <!-- 小吉祥物：Sleep Beast（簡單萌系 SVG） -->
      <svg class="beast" viewBox="0 0 64 64" aria-hidden>
        <circle cx="32" cy="32" r="28" fill="#fff" stroke="#FFEFE6" stroke-width="2"/>
        <ellipse cx="32" cy="40" rx="16" ry="10" fill="#FFEFE6"/>
        <circle cx="24" cy="30" r="4" fill="#3d3434"/>
        <circle cx="40" cy="30" r="4" fill="#3d3434"/>
        <path d="M22 44 q10 6 20 0" fill="none" stroke="#A37070" stroke-width="3" stroke-linecap="round"/>
        <path d="M18 16 l8 6" stroke="#A37070" stroke-width="3" stroke-linecap="round"/>
        <path d="M46 16 l-8 6" stroke="#A37070" stroke-width="3" stroke-linecap="round"/>
        <path d="M44 10 q6 6 0 12" fill="none" stroke="#A37070" stroke-width="3" stroke-linecap="round"/>
      </svg>
      <div>
        <div class="title">Sleep Beast 的小信箱</div>
        <div class="subtitle">打聲招呼吧～我會回你一個可愛的打呼</div>
      </div>
    </div>

    <div class="chat">
      <div id="msgs" class="msgs" aria-live="polite"></div>
      <div class="footer-note">＊留言只會私下送到我的收件服務，不公開顯示。<a href="#" id="privacy">隱私說明</a></div>
      <form id="form" class="input">
        <textarea id="text" placeholder="想說什麼都可以～（例：嗨，我是小王，可以加個朋友嗎？）" required></textarea>
        <button id="send" type="submit">送出</button>
      </form>
    </div>
  </div>

  <script>
    // —— 清一次舊版留下的本機資料，避免舊訊息又被載回 ——
    ['guestbook_chat_v2','guestbook_retry_v2','guestbook_retry_v3','guestbook_retry_v4']
      .forEach(k => { try { localStorage.removeItem(k); } catch(e){} });
    // 也順手把畫面訊息清乾淨（若有快取殘留）
    try { document.getElementById('msgs') && (document.getElementById('msgs').innerHTML = ''); } catch(e){}
    // ====== 必填：把這三個改成你的實際值 ======
    const WEBHOOK_URL = "https://linyy.app.n8n.cloud/webhook-test/friends"; // ⬅️ n8n Webhook 的 Production URL（不是 -test）
    const SHARED_KEY   = "my-expo-2025";  // 與 n8n IF 節點完全一致
    const EXHIBITION_NAME = "BoothA-2025"; // 來源標籤（可改攤位名、裝置名）

    // 可愛回覆（含你要求新增的句子）
    const BOT_REPLIES = [
      "收到啦～Sleep Beast 正在打呼但有聽到你 😪💤",
      "嘿嘿，感謝來逛！我把你的話塞進夢口袋了 ✨",
      "寫得好可愛，我之後一定回（醒來就回 😴）",
      "幫你傳好了！等我伸個懶腰再看 👋",
      "你的訊息像小棉花糖一樣軟綿綿 ☁️",
      "呼嚕呼嚕…啊！差點忘了回你 🐻💤",
      "我翻了個身，把你的話抱在懷裡 🤗",
      "有訊息進來！快點塞進枕頭底下 🛏️",
      "謝謝你偷偷來找我聊天～覺得幸福 💕",
      "你的字看起來好像星星在閃閃 ✨",
      "哼哼～我夢到你了，是不是被你召喚的 🪄",
      "好啦我醒一下，先回你再繼續睡 😌",
      "收到訊息～像被蓋上暖暖的被子 🛌",
      "嘿嘿～我打呼聲是不是蓋過訊息聲了 🙈",
      "偷偷告訴你，我超喜歡收到驚喜留言 🎁",
      "哇嗚～你出現在我的夢境留言板 🎨",
      "呼…睡一半收到訊息，覺得被陪伴 💭",
      "你的文字帶點甜味，好像蜂蜜牛奶 🥛🍯",
      "等我揉揉眼睛，就能回你更長的話啦 👀",
    ];

    // ====== DOM ======
    const msgs = document.getElementById('msgs');
    const form = document.getElementById('form');
    const text = document.getElementById('text');
    const sendBtn = document.getElementById('send');

    // 工具
    const RETRY_KEY = 'guestbook_retry_v4';
    function uid(){ return String(Date.now()) + '-' + Math.random().toString(16).slice(2); }
    function nowTW(){
      return new Date().toLocaleString('zh-TW',{
        timeZone:'Asia/Taipei',hour12:false,
        year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'
      });
    }

    function addRow(role, content, {id, note} = {}){
      const row = document.createElement('div');
      row.className = 'row ' + (role==='user'?'me':'bot');
      if(id) row.dataset.id = id;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      if(role==='bot') avatar.innerHTML = '🐻‍❄️'; else avatar.textContent = '你';

      const b = document.createElement('div');
      b.className = 'bubble ' + (role==='user'?'me':'bot');
      b.textContent = content;

      if((role==='me'||role==='user') && note){
        const s = document.createElement('span');
        s.className = 'status';
        s.textContent = note;
        b.appendChild(s);
      }

      if(role==='bot') row.appendChild(avatar);
      row.appendChild(b);
      if(role==='user') row.appendChild(avatar);

      msgs.appendChild(row);
      msgs.scrollTop = msgs.scrollHeight;
      return row;
    }

    function systemTip(t){
      const wrap = document.createElement('div');
      wrap.className = 'sys';
      const span = document.createElement('span');
      span.textContent = t;
      wrap.appendChild(span);
      msgs.appendChild(wrap);
      msgs.scrollTop = msgs.scrollHeight;
      return wrap;
    }

    // 乾淨重置：清除所有對話泡泡（用於送達或補送成功後）
    function clearConversation(){
      if (msgs) msgs.innerHTML = '';
    });
      if(!res.ok) throw new Error('deliver failed '+res.status);
      return await res.json().catch(()=>({ok:true}));
    }

    function queueRetry(msg, id){
      const q = JSON.parse(localStorage.getItem(RETRY_KEY)||'[]');
      q.push({msg, id, ts:Date.now()});
      localStorage.setItem(RETRY_KEY, JSON.stringify(q.slice(-50)));
    }

    // 背景補送：成功後移除畫面上的那則訊息
    setInterval(async ()=>{
      try{
        const q = JSON.parse(localStorage.getItem(RETRY_KEY)||'[]');
        if(!q.length) return;
        const item = q[0];
        await sendToBackend(item.msg, item.id);
        q.shift();
        localStorage.setItem(RETRY_KEY, JSON.stringify(q));
        clearConversation();
        systemTip('補送成功 ✅');
      }catch(e){/* 靜默重試 */}
    }, 15000);
        if(!q.length) return;
        const item = q[0];
        await sendToBackend(item.msg, item.id);
        q.shift();
        localStorage.setItem(RETRY_KEY, JSON.stringify(q));
        const row = document.querySelector(`[data-id="${item.id}"]`);
        if(row) row.remove();
        systemTip('補送成功 ✅');
      }catch(e){/* 靜默重試 */}
    }, 15000);

    // 初始提示
    systemTip('👋 嗨～丟一句話給我吧！');

    // 表單送出
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const value = text.value.trim();
      if(!value) return;

      // 清空輸入框，避免旁人看到
      text.value = '';
      sendBtn.disabled = true;

      // 先顯示使用者訊息 + 可愛回覆（暫時），送達後會清空
      const id = uid();
      addRow('user', value, {id, note:'傳送中…'});
      const replyText = BOT_REPLIES[Math.floor(Math.random()*BOT_REPLIES.length)];
      const timer = setTimeout(()=>addRow('bot', replyText), 250);

      try{
        await sendToBackend(value, id);
        clearTimeout(timer);
        // 成功：整個對話區清空，僅留一則系統提示
        clearConversation();
        systemTip('已送達 ✅ 謝謝你的留言！');
      }catch(err){
        // 失敗：保留訊息，標記等待補送
        const bubble = document.querySelector(`[data-id="${id}"] .bubble`);
        if(bubble){
          const s = document.createElement('span');
          s.className = 'status';
          s.textContent = '（等待補送）';
          bubble.appendChild(s);
        }
        queueRetry(value, id);
        systemTip('網路在打盹，先替你記下來，等會兒再送～');
      }finally{
        sendBtn.disabled = false;
      }
    });
      const value = text.value.trim();
      if(!value) return;

      // 清空輸入框
      text.value = '';
      sendBtn.disabled = true;

      // 先顯示使用者訊息 + 可愛回覆（暫時）
      const id = uid();
      addRow('user', value, {id, note:'傳送中…'});
      const replyText = BOT_REPLIES[Math.floor(Math.random()*BOT_REPLIES.length)];
      const timer = setTimeout(()=>addRow('bot', replyText), 250);

      try{
        const r = await sendToBackend(value, id);
        clearTimeout(timer);
        const userEl = document.querySelector(`[data-id="${id}"]`);
        if(userEl) userEl.remove();
        systemTip('已送達 ✅ Sleep Beast 幫你保管中');
      }catch(err){
        const bubble = document.querySelector(`[data-id="${id}"] .bubble`);
        if(bubble){
          const s = document.createElement('span');
          s.className = 'status';
          s.textContent = '（等待補送）';
          bubble.appendChild(s);
        }
        queueRetry(value, id);
        systemTip('網路在打盹，先替你記下來，等會兒再送～');
      }finally{
        sendBtn.disabled = false;
      }
    });

    // 隱私說明
    document.getElementById('privacy').addEventListener('click',(e)=>{
      e.preventDefault();
      alert('這個頁面只會把你輸入的文字私下傳給作者（透過 n8n / LINE），不會公開或長期儲存。若網路暫時不穩，會自動補送。');
    });

    // 防呆：檢查 URL 是否為 Production 格式
    if(!/^https:\/\/.+\/webhook\//.test(WEBHOOK_URL)){
      systemTip('⚠️ 目前使用的不是 Production Webhook URL，請到程式碼上方替換 WEBHOOK_URL');
    }
  </script>
</body>
</html>
